name: Build Android APK (Release)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'   # 👈 أي Tag يبدأ بـ v (مثال: v1.0.0) راح يعمل Build & Release

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: false

      - name: Fix Git permissions
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 🚀 Cache buildozer & pip
      - name: Cache buildozer and pip
        uses: actions/cache@v4
        with:
          path: |
            .buildozer
            ~/.buildozer
            ~/.cache/pip
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # 🔄 إصلاح مشكلة skcms
      - name: Redirect skcms to GitHub mirror
        run: |
          git config --global url."https://github.com/google/skcms.git".insteadOf "https://skia.googlesource.com/skcms"

      # 📦 Build APK
      - name: Build with Buildozer (Release)
        uses: ArtemSBulgakov/buildozer-action@v1.2.0
        with:
          command: buildozer -v android release

      # 📂 رفع كـ Artifact (للاختبار أو التحميل المباشر)
      - name: Upload Release APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: marble-granite-release-apk
          path: bin/*-release.apk

      # 🏷️ رفع الـ APK على GitHub Releases عند وجود Tag جديد
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: bin/*-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
