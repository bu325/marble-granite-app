name: Build Android APK (Release)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'   # ğŸ‘ˆ Ø£ÙŠ Tag ÙŠØ¨Ø¯Ø£ Ø¨Ù€ v (Ù…Ø«Ø§Ù„: v1.0.0) Ø±Ø§Ø­ ÙŠØ¹Ù…Ù„ Build & Release

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: false

      - name: Fix Git permissions
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ğŸš€ Cache buildozer & pip
      - name: Cache buildozer and pip
        uses: actions/cache@v4
        with:
          path: |
            .buildozer
            ~/.buildozer
            ~/.cache/pip
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # ğŸ”„ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© skcms
      - name: Redirect skcms to GitHub mirror
        run: |
          git config --global url."https://github.com/google/skcms.git".insteadOf "https://skia.googlesource.com/skcms"

      # ğŸ“¦ Build APK
      - name: Build with Buildozer (Release)
        uses: ArtemSBulgakov/buildozer-action@v1.2.0
        with:
          command: buildozer -v android release

      # ğŸ“‚ Ø±ÙØ¹ ÙƒÙ€ Artifact (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£Ùˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)
      - name: Upload Release APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: marble-granite-release-apk
          path: bin/*-release.apk

      # ğŸ·ï¸ Ø±ÙØ¹ Ø§Ù„Ù€ APK Ø¹Ù„Ù‰ GitHub Releases Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Tag Ø¬Ø¯ÙŠØ¯
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: bin/*-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
